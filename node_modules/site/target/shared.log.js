"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.error=exports.info=exports.add=exports.setFileOptions=exports.switchToSync=exports.setLowestLevel=exports.setAppenders=void 0;var e,t,o,r,n,i,s,l,u,c,d,a,p,f,y,v,h=require("./shared.manifest"),x=function(e){return null!=e},g=function(e,t,o,r){return e(t)[o](t,...r)},m=function(e){var t=e.call(this);return new Promise(function(e,o){!function r(n,i){try{var s=t[n](i),l=s.value}catch(e){return void o(e)}s.done?e(l):Promise.resolve(l).then(function(e){r("next",e)},function(e){r("throw",e)})}("next")})};h.sys.isNode&&(e=module.require("fs"),t=module.require("fs").promises,o=module.require("zlib"),r=new h.AsyncQueue),n=["console"],i=2,s=!1,l={daysToKeep:30,compressesOld:!0},u=function(e){return(()=>"info"===e?2:"error"===e?5:-99)()},exports.setAppenders=c=function(e){n=e},exports.setLowestLevel=d=function(e){i=e===-1/0||e===1/0?(()=>e)():(()=>u(e))()},exports.switchToSync=a=function(){s=!0},exports.setFileOptions=p=function(e){return void 0!==e.daysToKeep&&((0,h.assert)(e.daysToKeep===1/0||Number.isInteger(e.daysToKeep)&&0<=(t=e.daysToKeep)&&t<=365e3),l.daysToKeep=e.daysToKeep),void 0!==e.compressesOld?void(l.compressesOld=e.compressesOld):void 0;var t},new h.IntervalTimer({interval:864e5}).onArrive(function(e){return m.call(this,function*(){var r,i,s,u,c,d,a;return n.includes("file")?yield m.call(this,function*(){return(r=g(h.dotDot_573300145710716007,yield t.readdir("log"),"sort",[])).length>0?yield m.call(this,function*(){return r.pop(),i=r,Number.isFinite(l.daysToKeep)&&(yield m.call(this,function*(){return s=g(h.dotDot_573300145710716007,e.nowTime,"subtract",[86400*l.daysToKeep*1e3]).toISOString().substr(0,10),u=g(h.dotDot_573300145710716007,i,"group",[function(e){return(()=>e<s)()}]),c=g(h.dotDot_573300145710716007,u,"singleOrNull",[function(e){return(()=>!1===e[0])()}]),d=g(h.dotDot_573300145710716007,u,"singleOrNull",[function(e){return(()=>!0===e[0])()}]),i=x(c)?yield m.call(this,function*(){return c[1]}):yield m.call(this,function*(){return[]}),a=x(d)?yield m.call(this,function*(){return d[1]}):yield m.call(this,function*(){return[]}),yield g(h.dotDot_573300145710716007,a,"asyncForEach",[function(e){return m.call(this,function*(){return yield t.unlink("log/"+e)})}])})),l.compressesOld?yield m.call(this,function*(){return yield g(h.dotDot_573300145710716007,i.filter(function(e){return(()=>e.endsWith(".log"))()}),"asyncForEach",[function(e){return m.call(this,function*(){return yield t.writeFile("log/"+e+".gz",yield o.gzipAsync(yield t.readFile("log/"+e))),yield t.unlink("log/"+e)})}])}):void 0}):void 0}):void 0})}),exports.add=f=function(o,l,c){return void 0===l&&(l=""),void 0===c&&(c="info"),u(c)>=i?(()=>(d=(new Date).toISOString(),a=void 0===(p=JSON.stringify(o instanceof Error?(()=>({summary:o.toString(),stack:o.stack}))():(()=>o)()))?"()":p,"()"===a?void 0:(()=>JSON.parse(a))(),n.forEach(function(n){return(()=>"console"===n?(()=>console.log(d+"("+c+")"+l,o))():(()=>"file"===n?(()=>s?(()=>e.appendFileSync("log/"+d.substr(0,10)+".log",d+"("+c+")"+l+" "+a+"\n"))():(()=>r.add(function(){return m.call(this,function*(){return yield t.appendFile("log/"+d.substr(0,10)+".log",d+"("+c+")"+l+" "+a+"\n")})}))())():void 0)())()})))():void 0;var d,a,p},exports.info=y=function(e,t){return(()=>f(e,t,"info"))()},exports.error=v=function(e,t){return(()=>f(e,t,"error"))()},exports.setAppenders=c,exports.setLowestLevel=d,exports.switchToSync=a,exports.setFileOptions=p,exports.add=f,exports.info=y,exports.error=v;