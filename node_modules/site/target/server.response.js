"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("./shared.manifest"),t=i(require("./server.main")),r=i(require("url")),n=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(require("./server.common-responses")),s=i(require("./server.fs-scan")),a=i(require("./server.home-page"));function i(e){return e&&e.__esModule?e:{default:e}}var u,o,h,l,c,d,p=function(e){return null!=e},w=function(e,t){var r=e,n=r.split("\n");return r=(n=n.map(e=>{var t=e.indexOf(" #");return-1===t?e:e.substr(0,t)})).join("").replace(/\s/g,""),new RegExp(r,t)},f=function(e){var t=e.call(this);return new Promise(function(e,r){!function n(s,a){try{var i=t[s](a),u=i.value}catch(e){return void r(e)}i.done?e(u):Promise.resolve(u).then(function(e){n("next",e)},function(e){n("throw",e)})}("next")})};exports.default=(u=Symbol(),o=Symbol(),h=Symbol(),l=Symbol(),c=Symbol(),d=Symbol(),class{constructor(e,t){((e,t)=>(()=>(this.raw=e,this.context=t,this.context.response=this,this.raw.setHeader("Cache-Control","no-cache"),this.raw.setHeader("X-Content-Type-Options","nosniff"),this.raw.setHeader("X-Frame-Options","SAMEORIGIN")))())(e,t)}send(){return(()=>{var e=arguments;return(()=>{var t,r,n,s;return e.length>2?(()=>([t,r,n]=e,this.raw.statusCode=t,p(r)&&(()=>this.raw.setHeader("Content-Type",r))(),this.raw.end(n)))():(()=>([s]=e,this.raw.statusCode=200,this.raw.setHeader("Content-Type","application/json"),this.raw.end(JSON.stringify(s))))()})()})()}sendError(e){return(e=>(()=>(this.raw.statusCode=500,void 0===e?(()=>this.raw.end())():(()=>(this.raw.setHeader("Content-Type","application/json"),this.raw.end(JSON.stringify(e))))()))())(e)}sendFriendlyError(){return(()=>(()=>n.send500(this.raw))())()}[u](e,t){return((e,t)=>(()=>(this.raw.statusCode=t?301:302,this.raw.setHeader("Location",e),this.raw.end()))())(e,t)}redirect(e){return(e=>(()=>this[u](e,!1))())(e)}redirectPermanent(e){return(e=>(()=>this[u](e,!0))())(e)}[o](e,t){return((e,t)=>(()=>{var n,s,a,i,o;return n=r.default.parse(this.context.request.raw.url),s=this.context.request.port,a="//"+(e+(p(s)?(()=>":"+s)():""))+n.pathname+(void 0===(i=n.search)||null===i?"":i)+(void 0===(o=n.hash)||null===o?"":o),this[u](a,t)})())(e,t)}redirectHost(e){return(e=>(()=>this[o](e,!1))())(e)}redirectHostPermanent(e){return(e=>(()=>this[o](e,!0))())(e)}[h](e,t){return((e,t)=>(()=>{var n,s,a,i,o;return n=r.default.parse(this.context.request.raw.url),s=this.context.request.host.raw,a=e+"://"+s+n.pathname+(void 0===(i=n.search)||null===i?"":i)+(void 0===(o=n.hash)||null===o?"":o),this[u](a,t)})())(e,t)}redirectScheme(e){return(e=>(()=>this[h](e,!1))())(e)}redirectSchemePermanent(e){return(e=>(()=>this[h](e,!0))())(e)}[l](e,t,n){return((e,t,n)=>(()=>{var s,a,i,o;return s=r.default.parse(this.context.request.raw.url),a=e+"://"+t+s.pathname+(void 0===(i=s.search)||null===i?"":i)+(void 0===(o=s.hash)||null===o?"":o),this[u](a,n)})())(e,t,n)}redirectSchemeHost(e,t){return((e,t)=>(()=>this[l](e,t,!1))())(e,t)}redirectSchemeHostPermanent(e,t){return((e,t)=>(()=>this[l](e,t,!0))())(e,t)}[c](e,t){return((e,t)=>(()=>{var n,s,a,i;return n=r.default.parse(this.context.request.raw.url),s="//"+e+n.pathname+(void 0===(a=n.search)||null===a?"":a)+(void 0===(i=n.hash)||null===i?"":i),this[u](s,t)})())(e,t)}redirectAuthority(e){return(e=>(()=>this[c](e,!1))())(e)}redirectAuthorityPermanent(e){return(e=>(()=>this[c](e,!0))())(e)}[d](e,t,n){return((e,t,n)=>(()=>{var s,a,i,o;return s=r.default.parse(this.context.request.raw.url),a=e+"://"+t+s.pathname+(void 0===(i=s.search)||null===i?"":i)+(void 0===(o=s.hash)||null===o?"":o),this[u](a,n)})())(e,t,n)}redirectSchemeAuthority(e,t){return((e,t)=>(()=>this[d](e,t,!1))())(e,t)}redirectSchemeAuthorityPermanent(e,t){return((e,t)=>(()=>this[d](e,t,!0))())(e,t)}handleFile(){return(()=>(()=>{var n,a,i;return n=r.default.parse(this.context.request.raw.url,!0),a=this.context.request.path.raw,(0,e.loop)(a.length,t=>(()=>{var r,n;return r=a.charCodeAt(t),(0,e.assert)(!(0<=(n=r)&&n<=31||127===r))})()),(0,e.assert)(-1===a.search(w("(^|/|\\\\) (\\.\\.|\\.|~) ($|/|\\\\)"))),i=a.match(new RegExp("^(/|\\\\)\\.well-known(/|\\\\)(.+)$")),(0,e.assert)(-1===(p(i)?(()=>i[2]+i[3])():(()=>a)()).search(w("(^|/|\\\\) \\. [^/\\\\]+ ($|/|\\\\)"))),p(t.default.password)&&-1!==a.search(new RegExp("(^|/|\\\\|\\s)bundle-705357537593286848\\.js($|/|\\\\|\\s)","i"))&&(()=>(0,e.assert)(n.query.serverPassword_705357537593286848===t.default.password))(),new s.default(a,n,this.context.request.raw,this.context.response.raw,this.context).process()})())()}handleHome(){return(()=>(()=>new a.default(this.context.request.path,this.context.request.raw,this.context.response.raw,this.context).process())())()}handleOAuth(r,s,a){return((r,s,a)=>f.call(this,function*(){var i,u,o,h,l,c;return s instanceof Object&&!(s instanceof Function)&&(yield f.call(this,function*(){[s,a]=[a,s]})),void 0===a&&(a={}),i=void 0!==(c=a.savesAccessTokenToBrowser)&&c,u=this.context.request.queryObject,(0,e.assert)(p(u.code)&&p(u.state)),o=yield r.requestAccessToken(u.code,{tokenRequestHeaderFields:a.tokenRequestHeaderFields}),l=(h=p(s)?yield f.call(this,function*(){return yield s(o)}):yield f.call(this,function*(){return null}))instanceof t.default.OAuth.BrowserAttachment?yield f.call(this,function*(){return h.value}):yield f.call(this,function*(){return null}),n.sendOAuthCallback(u.state,i?yield f.call(this,function*(){return{name:r.getName(),accessToken:o.accessToken}}):yield f.call(this,function*(){return null}),l,this.raw)}))(r,s,a)}});